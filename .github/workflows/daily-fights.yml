name: Daily Fights

# Spread 150 fights across 3 runs per day (UTC times)
# Progressive: 35% + 35% + 100% of remaining = guaranteed full usage
on:
  schedule:
    - cron: '0 17 * * *'   # 17:00 UTC = 18:00 CET (batch 1: ~35%)
    - cron: '0 20 * * *'   # 20:00 UTC = 21:00 CET (batch 2: ~35%)
    - cron: '30 22 * * *'  # 22:30 UTC = 23:30 CET (final sweep: 100%)
  workflow_dispatch:  # Manual trigger
    inputs:
      percent:
        description: 'Percentage of fights to use'
        required: false
        default: '100'
      dry_run:
        description: 'Dry run (check only)'
        required: false
        default: 'false'
        type: boolean

jobs:
  run-fights:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: 2.0.1
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}

      - name: Install dependencies
        run: poetry install --no-interaction --no-root

      - name: Run daily fights
        env:
          LEEKWARS_USER: ${{ secrets.LEEKWARS_USER }}
          LEEKWARS_PASS: ${{ secrets.LEEKWARS_PASS }}
        run: |
          # Determine percent based on trigger
          HOUR=$(date -u +%H)
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual trigger: use inputs
            PERCENT="${{ github.event.inputs.percent || '100' }}"
            DRY_RUN="${{ github.event.inputs.dry_run || 'false' }}"
            echo "Manual trigger: $PERCENT% (dry_run=$DRY_RUN) [UTC hour: $HOUR]"
          else
            # Scheduled: progressive percentages based on UTC hour
            if [ "$HOUR" = "17" ] || [ "$HOUR" = "20" ]; then
              PERCENT=35  # Early batches: partial
            else
              PERCENT=100  # Final sweep: all remaining
            fi
            DRY_RUN="false"
            echo "Scheduled run: $PERCENT% at UTC hour $HOUR"
          fi

          # --no-buy: Only use free 50/day, don't spend habs on extra packs
          if [ "$DRY_RUN" = "true" ]; then
            poetry run python scripts/auto_daily_fights.py --percent $PERCENT --no-buy --dry-run
          else
            poetry run python scripts/auto_daily_fights.py --percent $PERCENT --no-buy
          fi

      - name: Upload logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: fight-logs
          path: logs/auto_fights.log
          retention-days: 30
