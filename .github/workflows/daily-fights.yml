name: Daily Fights

# Spread 50 fights across 5 runs per day (~10 each)
# Times in Paris (CET/CEST) converted to UTC
# Progressive batches allow monitoring and stopping if issues detected
on:
  schedule:
    - cron: '55 18 * * *'  # 18:55 UTC = 19:55 Paris (batch 1: 10 fights)
    - cron: '55 19 * * *'  # 19:55 UTC = 20:55 Paris (batch 2: 10 fights)
    - cron: '55 20 * * *'  # 20:55 UTC = 21:55 Paris (batch 3: 10 fights)
    - cron: '55 21 * * *'  # 21:55 UTC = 22:55 Paris (batch 4: 10 fights)
    - cron: '55 22 * * *'  # 22:55 UTC = 23:55 Paris (batch 5: remaining)
  workflow_dispatch:  # Manual trigger
    inputs:
      percent:
        description: 'Percentage of fights to use'
        required: false
        default: '100'
      dry_run:
        description: 'Dry run (check only)'
        required: false
        default: 'false'
        type: boolean

jobs:
  run-fights:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: 2.0.1
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}

      - name: Install dependencies
        run: poetry install --no-interaction --no-root

      - name: Run daily fights
        env:
          LEEKWARS_USER: ${{ secrets.LEEKWARS_USER }}
          LEEKWARS_PASS: ${{ secrets.LEEKWARS_PASS }}
        run: |
          # Determine percent based on trigger
          HOUR=$(date -u +%H)
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual trigger: use inputs
            PERCENT="${{ github.event.inputs.percent || '100' }}"
            DRY_RUN="${{ github.event.inputs.dry_run || 'false' }}"
            echo "Manual trigger: $PERCENT% (dry_run=$DRY_RUN) [UTC hour: $HOUR]"
          else
            # Scheduled: 5 batches of ~10 fights each (20% per batch)
            # Last batch (22:55 UTC) sweeps remaining to ensure full usage
            if [ "$HOUR" = "22" ]; then
              PERCENT=100  # Final sweep: all remaining
            else
              PERCENT=20   # ~10 fights per batch
            fi
            DRY_RUN="false"
            echo "Scheduled run: $PERCENT% at UTC hour $HOUR"
          fi

          # --no-buy: Only use free 50/day, don't spend habs on extra packs
          if [ "$DRY_RUN" = "true" ]; then
            poetry run python scripts/auto_daily_fights.py --percent $PERCENT --no-buy --dry-run
          else
            poetry run python scripts/auto_daily_fights.py --percent $PERCENT --no-buy
          fi

      - name: Upload logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: fight-logs
          path: logs/auto_fights.log
          retention-days: 30
